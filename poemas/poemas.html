<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poemas - Nuestra Historia üíô</title>
    <meta name="theme-color" content="#05bfdb">
    <link rel="stylesheet" href="../styles/styles-poemas.css">
    <link rel="stylesheet" href="../styles/styles-modal-poemas.css">
    <!-- Navbar del index -->
    <link rel="stylesheet" href="../styles/styles-index.css">
</head>
<body>
    <!-- Navbar igual al index (adaptando rutas relativas) -->
    <nav class="navbar-simple">
        <div class="nav-content">
            <a href="../index.html" class="logo-simple">üíô Nuestra Historia</a>
            <button class="nav-toggle" aria-label="Abrir men√∫" aria-expanded="false" aria-controls="menu-simple">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu-simple" id="menu-simple">
                <li><a href="../index.html">Inicio</a></li>
                <li><a href="poemas.html">Poemas</a></li>
                <li><a href="../canciones/canciones.html">Canciones</a></li>
                <li><a href="../galeria/galeria.html">Galer√≠a</a></li>
                <li><a href="../mensajes/mensajes.html">Mensajes</a></li>
            </ul>
        </div>
    </nav>

    <!-- Contenido -->
    <section class="poemas">
        <div class="container">
            <h2 class="seccion-titulo">üìù Poemas</h2>
            
            <!-- Buscador -->
            <div class="buscador-container">
                <input type="text" id="buscador-poemas" class="buscador-input" placeholder="üîç Buscar por t√≠tulo, contenido o autor..." />
                <button id="btn-limpiar-busqueda" class="btn-limpiar">‚úï Limpiar</button>
            </div>
            
            <div id="poemas-container">
                <!-- Los poemas se cargar√°n aqu√≠ -->
            </div>

            <!-- Paginaci√≥n -->
            <div class="paginacion" id="paginacion">
                <!-- Los botones de paginaci√≥n se generar√°n aqu√≠ -->
            </div>

            <button class="btn-agregar" id="btn-agregar-poema">Agregar Poema</button>
        </div>
    </section>

    <!-- Modal para agregar/editar poema -->
    <div id="modal-poema" class="modal-poema" style="display: none;">
        <div class="modal-poema-content">
            <div class="modal-header">
                <h3 id="modal-titulo">Agregar Poema</h3>
                <button class="btn-cerrar-modal" id="btn-cerrar-modal">&times;</button>
            </div>
            <form id="form-poema">
                <div class="form-group">
                    <label for="poema-titulo">T√≠tulo del Poema:</label>
                    <input type="text" id="poema-titulo" placeholder="Ingresa el t√≠tulo" required>
                </div>
                <div class="form-group">
                    <label for="poema-contenido">Contenido:</label>
                    <textarea id="poema-contenido" placeholder="Escribe el poema..." rows="8" required></textarea>
                </div>
                <div class="form-group">
                    <label for="poema-autor">Autor/Dedicatoria:</label>
                    <input type="text" id="poema-autor" placeholder="Ej: Con amor ‚ù§Ô∏è">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn-cancelar" id="btn-cancelar">Cancelar</button>
                    <button type="submit" class="btn-guardar">Guardar Poema</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Hecho con üíô para la persona que amo</p>
        <p class="footer-date">Actualizado el: <span id="fecha"></span></p>
    </footer>

    <script src="../config.js"></script>
    <script src="../script.js"></script>
    <script>
        const POEMAS_POR_PAGINA = 12;
        let paginaActual = 1;
        let poemaDatosEditando = null;
        let poemasEnPantalla = []; // Array para filtros
        const BACKEND_URL = CONFIG.BACKEND_URL + '/poemas';

        // Cargar poemas desde el backend
        async function cargarPoemasDelBackend() {
            try {
                console.log('üîÑ Cargando poemas del backend...');
                const res = await fetch(`${BACKEND_URL}/get`);
                const data = await res.json();
                if (data.success && data.poemas) {
                    window.POEMAS = data.poemas;
                    poemasEnPantalla = [...window.POEMAS]; // Inicializar array de pantalla
                    console.log(`‚úÖ ${data.poemas.length} poemas cargados del backend`);
                    return true;
                }
            } catch (err) {
                console.warn('‚ö†Ô∏è Error cargando del backend:', err);
            }
            return false;
        }

        // Guardar poemas en el backend
        async function guardarPoemasEnBackend() {
            try {
                console.log(`üì§ Guardando ${window.POEMAS.length} poemas en el backend...`);
                const res = await fetch(`${BACKEND_URL}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ poemas: window.POEMAS })
                });
                const data = await res.json();
                if (data.success) {
                    console.log(`‚úÖ Guardado exitoso: ${data.total} poemas en servidor`);
                    return true;
                } else {
                    console.error(`‚ùå Error al guardar: ${data.error}`);
                    return false;
                }
            } catch (err) {
                console.error('‚ùå Error guardando en backend:', err);
                return false;
            }
        }

        // Funci√≥n de b√∫squeda
        function filtrarPoemas(texto) {
            texto = texto.toLowerCase().trim();
            console.log(`üîç Buscando: "${texto}"`);
            
            if (texto === '') {
                poemasEnPantalla = [...window.POEMAS];
            } else {
                poemasEnPantalla = window.POEMAS.filter(poema => 
                    poema.titulo.toLowerCase().includes(texto) ||
                    poema.contenido.toLowerCase().includes(texto) ||
                    poema.autor.toLowerCase().includes(texto)
                );
            }
            
            paginaActual = 1; // Volver a la primera p√°gina
            mostrarPoemas();
            console.log(`üìä Resultados encontrados: ${poemasEnPantalla.length}`);
        }

        function mostrarPoemas() {
            const container = document.getElementById('poemas-container');
            container.innerHTML = '';

            const inicio = (paginaActual - 1) * POEMAS_POR_PAGINA;
            const fin = inicio + POEMAS_POR_PAGINA;
            const poemasEnPagina = poemasEnPantalla.slice(inicio, fin);

            if (poemasEnPagina.length === 0) {
                if (poemasEnPantalla.length === 0) {
                    container.innerHTML = '<div class="no-resultados">üòî No se encontraron poemas con tu b√∫squeda...</div>';
                } else {
                    container.innerHTML = '<div class="no-items">A√∫n no hay poemas... pero aqu√≠ escribir√© nuestras historias üåπ</div>';
                }
                actualizarPaginacion();
                return;
            }

            poemasEnPagina.forEach((poema, index) => {
                const indicePrincipal = inicio + index;
                const div = document.createElement('div');
                div.className = 'poema-card';
                div.style.animation = `fadeInUp 0.6s ease-out ${index * 0.1}s both`;
                div.innerHTML = `
                    <h3>Poema #${indicePrincipal + 1}: ${poema.titulo}</h3>
                    <div class="poema-contenido">
                        <p>${poema.contenido}</p>
                    </div>
                    <span class="fecha">‚Äî ${poema.autor || 'Escrito con amor ‚ù§Ô∏è'}</span>
                    <div class="botones-poema-menu">
                        <button class="btn-menu-toggle" onclick="toggleMenuPoema(this)">+</button>
                        <div class="botones-poema-desplegable">
                            <button class="btn-editar" onclick="editarPoema(${indicePrincipal})">‚úé Editar</button>
                            <button class="btn-eliminar" onclick="eliminarPoema(${indicePrincipal})">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            actualizarPaginacion();
        }

        function actualizarPaginacion() {
            const totalPaginas = Math.ceil(poemasEnPantalla.length / POEMAS_POR_PAGINA);
            const paginacionDiv = document.getElementById('paginacion');
            paginacionDiv.innerHTML = '';

            // Bot√≥n anterior
            const btnAnterior = document.createElement('button');
            btnAnterior.className = 'pagina-btn ' + (paginaActual === 1 ? 'deshabilitada' : '');
            btnAnterior.textContent = '‚Üê Anterior';
            btnAnterior.disabled = paginaActual === 1;
            btnAnterior.onclick = () => {
                if (paginaActual > 1) {
                    paginaActual--;
                    mostrarPoemas();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            paginacionDiv.appendChild(btnAnterior);

            // N√∫meros de p√°gina
            for (let i = 1; i <= totalPaginas; i++) {
                const btn = document.createElement('button');
                btn.className = 'pagina-btn ' + (i === paginaActual ? 'activa' : '');
                btn.textContent = i;
                btn.onclick = () => {
                    paginaActual = i;
                    mostrarPoemas();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                paginacionDiv.appendChild(btn);
            }

            // Bot√≥n siguiente
            const btnSiguiente = document.createElement('button');
            btnSiguiente.className = 'pagina-btn ' + (paginaActual === totalPaginas ? 'deshabilitada' : '');
            btnSiguiente.textContent = 'Siguiente ‚Üí';
            btnSiguiente.disabled = paginaActual === totalPaginas;
            btnSiguiente.onclick = () => {
                if (paginaActual < totalPaginas) {
                    paginaActual++;
                    mostrarPoemas();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            paginacionDiv.appendChild(btnSiguiente);
        }

        // Modal Functions
        function mostrarModal(titulo = 'Agregar Poema') {
            document.getElementById('modal-titulo').textContent = titulo;
            document.getElementById('modal-poema').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function cerrarModal() {
            document.getElementById('modal-poema').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('form-poema').reset();
            poemaDatosEditando = null;
        }

        // Agregar poema
        function abrirFormularioAgregar() {
            poemaDatosEditando = null;
            document.getElementById('form-poema').reset();
            mostrarModal('Agregar Poema');
        }

        // Editar poema
        function editarPoema(indice) {
            console.log(`‚úèÔ∏è Editando poema en √≠ndice: ${indice}`);
            if (!POEMAS[indice]) {
                console.error(`‚ùå Poema no encontrado en √≠ndice ${indice}`);
                alert('Error: Poema no encontrado');
                return;
            }
            poemaDatosEditando = indice;
            const poema = POEMAS[indice];
            console.log(`üìù Datos del poema a editar:`, poema);
            document.getElementById('poema-titulo').value = poema.titulo;
            document.getElementById('poema-contenido').value = poema.contenido;
            document.getElementById('poema-autor').value = poema.autor || '';
            mostrarModal('Editar Poema');
        }

        // Eliminar poema con confirmaci√≥n
        async function eliminarPoema(indice) {
            console.log(`üóëÔ∏è Intentando eliminar poema en √≠ndice: ${indice}`);
            if (!POEMAS[indice]) {
                console.error(`‚ùå Poema no encontrado en √≠ndice ${indice}`);
                alert('Error: Poema no encontrado');
                return;
            }
            const titulo = POEMAS[indice].titulo;
            if (confirm(`¬øEst√°s seguro de que quieres eliminar el poema "${titulo}"?`)) {
                console.log(`üìö Poemas antes de eliminar: ${POEMAS.length}`);
                POEMAS.splice(indice, 1);
                console.log(`üìö Poemas despu√©s de eliminar: ${POEMAS.length}`);
                
                const guardado = await guardarPoemasEnBackend();
                if (guardado) {
                    console.log(`‚úÖ Poema eliminado y guardado en backend`);
                    // Recargar p√°gina para mostrar cambios
                    window.location.reload();
                } else {
                        paginaActual = 1;
                    }
                    mostrarPoemas();
                } else {
                    console.error(`‚ùå Error al guardar en backend despu√©s de eliminar`);
                    alert('Error al eliminar. Intenta de nuevo.');
                }
            }
        }

        // Toggle menu de acciones en poema
        function toggleMenuPoema(btn) {
            const menu = btn.parentElement.querySelector('.botones-poema-desplegable');
            menu.classList.toggle('visible');
            btn.classList.toggle('activo');
        }

        // Cerrar men√∫ al hacer clic en otra parte
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.botones-poema-menu')) {
                document.querySelectorAll('.botones-poema-desplegable.visible').forEach(menu => {
                    menu.classList.remove('visible');
                    menu.previousElementSibling.classList.remove('activo');
                });
            }
        });

        // Guardar poema (agregar o editar)
        async function guardarPoema(evento) {
            evento.preventDefault();
            
            const titulo = document.getElementById('poema-titulo').value.trim();
            const contenido = document.getElementById('poema-contenido').value.trim();
            const autor = document.getElementById('poema-autor').value.trim();

            if (!titulo || !contenido) {
                alert('Por favor completa el t√≠tulo y contenido del poema');
                return;
            }

            console.log(`üñäÔ∏è ${poemaDatosEditando !== null ? 'Editando' : 'Agregando'} poema: "${titulo}"`);
            console.log(`üìö Poemas actuales antes: ${window.POEMAS.length}`);

            const nuevoPoema = { titulo, contenido, autor: autor || 'Escrito con amor ‚ù§Ô∏è' };
            
            if (poemaDatosEditando !== null) {
                const indiceEditando = poemaDatosEditando;
                console.log(`‚úèÔ∏è Reemplazando poema en √≠ndice ${indiceEditando}`);
                console.log(`  Anterior:`, window.POEMAS[indiceEditando]);
                window.POEMAS[indiceEditando] = nuevoPoema;
                console.log(`  Nuevo:`, window.POEMAS[indiceEditando]);
            } else {
                window.POEMAS.push(nuevoPoema);
                console.log(`‚úÖ Poema agregado. Total ahora: ${window.POEMAS.length}`);
            }

            console.log(`üì§ Enviando ${window.POEMAS.length} poemas al backend...`);
            
            // Guardar en backend
            const guardado = await guardarPoemasEnBackend();
            if (guardado) {
                console.log('‚ú® Poema guardado exitosamente en el backend');
                poemaDatosEditando = null; // Limpiar estado de edici√≥n
                cerrarModal();
                // Recargar p√°gina para mostrar cambios
                window.location.reload();
            } else {
                console.error('‚ùå Error al guardar en backend');
                alert('Error al guardar. Intenta de nuevo.');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Toggle men√∫ m√≥vil
            const navToggle = document.querySelector('.nav-toggle');
            const navMenu = document.getElementById('menu-simple');
            if (navToggle && navMenu) {
                navToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const abierto = navMenu.classList.toggle('open');
                    navToggle.setAttribute('aria-expanded', abierto ? 'true' : 'false');
                });
                
                // Cerrar men√∫ cuando se hace click en un link
                navMenu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('open');
                        navToggle.setAttribute('aria-expanded', 'false');
                    });
                });
                
                // Cerrar men√∫ cuando se hace click fuera
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.navbar-simple')) {
                        navMenu.classList.remove('open');
                        navToggle.setAttribute('aria-expanded', 'false');
                    }
                });
            }
            
            // Cargar poemas del backend
            const cargado = await cargarPoemasDelBackend();
            if (!cargado) {
                console.warn('‚ö†Ô∏è No se pudo cargar del backend, usando array vac√≠o');
                window.POEMAS = [];
            }
            
            mostrarPoemas();

            // Bot√≥n agregar
            document.getElementById('btn-agregar-poema').addEventListener('click', abrirFormularioAgregar);

            // Buscador
            const buscadorInput = document.getElementById('buscador-poemas');
            const btnLimpiar = document.getElementById('btn-limpiar-busqueda');
            
            buscadorInput.addEventListener('input', (e) => {
                filtrarPoemas(e.target.value);
            });
            
            btnLimpiar.addEventListener('click', () => {
                buscadorInput.value = '';
                filtrarPoemas('');
                buscadorInput.focus();
            });

            // Modal
            document.getElementById('btn-cerrar-modal').addEventListener('click', cerrarModal);
            document.getElementById('btn-cancelar').addEventListener('click', cerrarModal);
            document.getElementById('form-poema').addEventListener('submit', guardarPoema);

            // Cerrar modal al hacer clic fuera
            document.getElementById('modal-poema').addEventListener('click', (e) => {
                if (e.target.id === 'modal-poema') {
                    cerrarModal();
                }
            });

            // Cerrar modal con tecla Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('modal-poema').style.display === 'flex') {
                    cerrarModal();
                }
            });
        });
    </script>
</body>
</html>

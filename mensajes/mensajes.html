<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mensajes - Nuestra Historia ğŸ’™</title>
    <link rel="stylesheet" href="../styles/styles-mensajes.css">
    <link rel="stylesheet" href="../styles/styles-modal-mensajes.css">
    <!-- Navbar del index -->
    <link rel="stylesheet" href="../styles/styles-index.css">
</head>
<body>
    <!-- NavegaciÃ³n -->
    <nav class="navbar-simple">
        <div class="nav-content">
            <a href="../index.html" class="logo-simple">ğŸ’™ Nuestra Historia</a>
            <button class="nav-toggle" aria-label="Abrir menÃº" aria-expanded="false" aria-controls="menu-simple">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu-simple" id="menu-simple">
                <li><a href="../index.html">Inicio</a></li>
                <li><a href="../poemas/poemas.html">Poemas</a></li>
                <li><a href="../canciones/canciones.html">Canciones</a></li>
                <li><a href="../galeria/galeria.html">GalerÃ­a</a></li>
                <li><a href="mensajes.html">Mensajes</a></li>
            </ul>
        </div>
    </nav>

    <!-- Contenido -->
    <section class="mensajes">
        <div class="container">
            <h2 class="seccion-titulo">ğŸ’¬ Mensajes Especiales Para Ti</h2>
            
            <div id="mensajes-container">
                <!-- Los mensajes se cargarÃ¡n aquÃ­ -->
            </div>

            <!-- PaginaciÃ³n -->
            <div class="paginacion" id="paginacion">
                <!-- Los botones de paginaciÃ³n se generarÃ¡n aquÃ­ -->
            </div>

            <!-- BotÃ³n Agregar -->
            <div style="text-align: center; margin-top: 3rem; margin-bottom: 3rem;">
                <button class="btn-agregar" id="btn-agregar-mensaje">+ Agregar Mensaje</button>
            </div>
        </div>
    </section>

    <!-- Modal para agregar/editar mensaje -->
    <div id="modal-mensaje" class="modal-mensaje" style="display: none;">
        <div class="modal-mensaje-content">
            <div class="modal-header">
                <h3 id="modal-titulo">Agregar Mensaje</h3>
                <button class="btn-cerrar-modal" id="btn-cerrar-modal">&times;</button>
            </div>
            <form id="form-mensaje">
                <div class="form-group">
                    <label for="mensaje-asunto">Asunto:</label>
                    <input type="text" id="mensaje-asunto" placeholder="Ej: Mi amor por ti" required>
                </div>
                <div class="form-group">
                    <label for="mensaje-contenido">Mensaje:</label>
                    <textarea id="mensaje-contenido" placeholder="Escribe tu mensaje especial..." rows="6" required></textarea>
                </div>
                <div class="form-group">
                    <label for="mensaje-fecha">Fecha (opcional):</label>
                    <input type="date" id="mensaje-fecha">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn-cancelar" id="btn-cancelar">Cancelar</button>
                    <button type="submit" class="btn-guardar">Guardar Mensaje</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Hecho con ğŸ’™ para la persona que amo</p>
        <p class="footer-date">Actualizado el: <span id="fecha"></span></p>
    </footer>

    <script src="../config.js"></script>
    <script src="../script.js"></script>
    <script src="mensajes-data.js"></script>
    <script>
        const MENSAJES_POR_PAGINA = 12;
        let paginaActual = 1;
        let mensajeDatosEditando = null;
        const BACKEND_URL = CONFIG.BACKEND_URL + '/mensajes';

        function cargarMensajesDelStorage() {
            const mensajesGuardados = localStorage.getItem('mensajes_app');
            if (mensajesGuardados) {
                try {
                    window.MENSAJES = JSON.parse(mensajesGuardados);
                } catch (e) {
                    console.log('Usando mensajes por defecto');
                }
            }
        }

        async function guardarMensajesEnStorage() {
            try {
                const response = await fetch(CONFIG.BACKEND_URL + '/mensajes/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mensajes: window.MENSAJES })
                });
                const data = await response.json();
                return data.success;
            } catch (error) {
                console.error('Error guardando mensajes:', error);
                return false;
            }
        }

        function mostrarMensajes() {
            const container = document.getElementById('mensajes-container');
            container.innerHTML = '';

            const inicio = (paginaActual - 1) * MENSAJES_POR_PAGINA;
            const fin = inicio + MENSAJES_POR_PAGINA;
            const mensajesEnPagina = MENSAJES.slice(inicio, fin);

            mensajesEnPagina.forEach((mensaje, index) => {
                const indicePrincipal = inicio + index;
                const div = document.createElement('div');
                div.className = 'mensaje-box';
                div.style.animation = `fadeInUp 0.6s ease-out ${index * 0.1}s both`;
                div.innerHTML = `
                    <h3>${mensaje.asunto || 'Mensaje Especial'}</h3>
                    <p class="mensaje-texto">"${mensaje.contenido || mensaje.texto}"</p>
                    <span class="fecha-mensaje">${mensaje.fecha || 'Sin fecha'}</span>
                    <div class="botones-mensaje-menu">
                        <button class="btn-menu-toggle" onclick="toggleMenuMensaje(this)">+</button>
                        <div class="botones-mensaje-desplegable">
                            <button class="btn-editar" onclick="editarMensaje(${indicePrincipal})">âœ Editar</button>
                            <button class="btn-eliminar" onclick="eliminarMensaje(${indicePrincipal})">ğŸ—‘ï¸ Eliminar</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            actualizarPaginacion();
        }

        function actualizarPaginacion() {
            const totalPaginas = Math.ceil(MENSAJES.length / MENSAJES_POR_PAGINA);
            const paginacionDiv = document.getElementById('paginacion');
            paginacionDiv.innerHTML = '';

            // BotÃ³n anterior
            const btnAnterior = document.createElement('button');
            btnAnterior.className = 'pagina-btn ' + (paginaActual === 1 ? 'deshabilitada' : '');
            btnAnterior.textContent = 'â† Anterior';
            btnAnterior.disabled = paginaActual === 1;
            btnAnterior.onclick = () => {
                if (paginaActual > 1) {
                    paginaActual--;
                    mostrarMensajes();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            paginacionDiv.appendChild(btnAnterior);

            // NÃºmeros de pÃ¡gina
            for (let i = 1; i <= totalPaginas; i++) {
                const btn = document.createElement('button');
                btn.className = 'pagina-btn ' + (i === paginaActual ? 'activa' : '');
                btn.textContent = i;
                btn.onclick = () => {
                    paginaActual = i;
                    mostrarMensajes();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                paginacionDiv.appendChild(btn);
            }

            // BotÃ³n siguiente
            const btnSiguiente = document.createElement('button');
            btnSiguiente.className = 'pagina-btn ' + (paginaActual === totalPaginas ? 'deshabilitada' : '');
            btnSiguiente.textContent = 'Siguiente â†’';
            btnSiguiente.disabled = paginaActual === totalPaginas;
            btnSiguiente.onclick = () => {
                if (paginaActual < totalPaginas) {
                    paginaActual++;
                    mostrarMensajes();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            paginacionDiv.appendChild(btnSiguiente);
        }

        function toggleMenuMensaje(btn) {
            const menu = btn.parentElement.querySelector('.botones-mensaje-desplegable');
            menu.classList.toggle('visible');
            btn.classList.toggle('activo');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.botones-mensaje-menu')) {
                document.querySelectorAll('.botones-mensaje-desplegable.visible').forEach(menu => {
                    menu.classList.remove('visible');
                    menu.previousElementSibling.classList.remove('activo');
                });
            }
        });

        function mostrarModal(titulo = 'Agregar Mensaje') {
            document.getElementById('modal-titulo').textContent = titulo;
            document.getElementById('modal-mensaje').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function cerrarModal() {
            document.getElementById('modal-mensaje').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('form-mensaje').reset();
            mensajeDatosEditando = null;
        }

        function abrirFormularioAgregar() {
            mensajeDatosEditando = null;
            document.getElementById('form-mensaje').reset();
            mostrarModal('Agregar Mensaje');
        }

        function editarMensaje(indice) {
            mensajeDatosEditando = indice;
            const mensaje = MENSAJES[indice];
            document.getElementById('mensaje-asunto').value = mensaje.asunto || '';
            document.getElementById('mensaje-contenido').value = mensaje.contenido || mensaje.texto || '';
            document.getElementById('mensaje-fecha').value = mensaje.fecha || '';
            mostrarModal('Editar Mensaje');
        }

        async function eliminarMensaje(indice) {
            if (confirm(`Â¿EstÃ¡s seguro de que quieres eliminar este mensaje?`)) {
                MENSAJES.splice(indice, 1);
                const guardado = await guardarMensajesEnStorage();
                
                if (guardado) {
                    // Recargar pÃ¡gina para mostrar cambios
                    window.location.reload();
                } else {
                    alert('Error al eliminar. Intenta de nuevo.');
                }
            }
        }

        async function guardarMensaje(evento) {
            evento.preventDefault();
            
            const asunto = document.getElementById('mensaje-asunto').value.trim();
            const contenido = document.getElementById('mensaje-contenido').value.trim();
            const fecha = document.getElementById('mensaje-fecha').value;

            if (!asunto || !contenido) {
                alert('Por favor completa el asunto y el contenido');
                return;
            }

            if (mensajeDatosEditando !== null) {
                MENSAJES[mensajeDatosEditando] = { asunto, contenido, fecha, texto: contenido };
            } else {
                MENSAJES.push({ asunto, contenido, fecha, texto: contenido });
            }

            const guardado = await guardarMensajesEnStorage();
            if (guardado) {
                cerrarModal();
                // Recargar pÃ¡gina para mostrar cambios
                window.location.reload();
            } else {
                alert('Error al guardar. Intenta de nuevo.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            cargarMensajesDelStorage();
            mostrarMensajes();

            document.getElementById('btn-agregar-mensaje').addEventListener('click', abrirFormularioAgregar);
            document.getElementById('btn-cerrar-modal').addEventListener('click', cerrarModal);
            document.getElementById('btn-cancelar').addEventListener('click', cerrarModal);
            document.getElementById('form-mensaje').addEventListener('submit', guardarMensaje);

            document.getElementById('modal-mensaje').addEventListener('click', (e) => {
                if (e.target.id === 'modal-mensaje') {
                    cerrarModal();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('modal-mensaje').style.display === 'flex') {
                    cerrarModal();
                }
            });

            // Toggle menÃº mÃ³vil
            const navToggle = document.querySelector('.nav-toggle');
            const navMenu = document.getElementById('menu-simple');
            if (navToggle && navMenu) {
                navToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const abierto = navMenu.classList.toggle('open');
                    navToggle.setAttribute('aria-expanded', abierto ? 'true' : 'false');
                });
                
                // Cerrar menÃº cuando se hace click en un link
                navMenu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('open');
                        navToggle.setAttribute('aria-expanded', 'false');
                    });
                });
                
                // Cerrar menÃº cuando se hace click fuera
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.navbar-simple')) {
                        navMenu.classList.remove('open');
                        navToggle.setAttribute('aria-expanded', 'false');
                    }
                });
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canciones - Nuestra Historia üíô</title>
    <meta name="theme-color" content="#05bfdb">
    <link rel="stylesheet" href="../styles/styles-canciones-turquesa.css">
    <link rel="stylesheet" href="../styles/styles-modal-canciones.css">
    <!-- Navbar del index -->
    <link rel="stylesheet" href="../styles/styles-index.css">
</head>
<body>
    <!-- Navbar igual al index (adaptando rutas relativas) -->
    <nav class="navbar-simple">
        <div class="nav-content">
            <a href="../index.html" class="logo-simple">üíô Nuestra Historia</a>
            <button class="nav-toggle" aria-label="Abrir men√∫" aria-expanded="false" aria-controls="menu-simple">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu-simple" id="menu-simple">
                <li><a href="../index.html">Inicio</a></li>
                <li><a href="../poemas/poemas.html">Poemas</a></li>
                <li><a href="canciones.html">Canciones</a></li>
                <li><a href="../galeria/galeria.html">Galer√≠a</a></li>
                <li><a href="../mensajes/mensajes.html">Mensajes</a></li>
            </ul>
        </div>
    </nav>

    <!-- Contenido -->
    <section class="canciones">
        <div class="container">
            <h2 class="seccion-titulo">üéµ Canciones</h2>
            
            <!-- Buscador -->
            <div class="buscador-container">
                <input type="text" id="buscador-canciones" class="buscador-input" placeholder="üîç Buscar por t√≠tulo, artista..." />
                <button id="btn-limpiar-busqueda" class="btn-limpiar">‚úï Limpiar</button>
            </div>
            
            <div id="canciones-container">
                <!-- Las canciones se cargar√°n aqu√≠ -->
            </div>

            <!-- Paginaci√≥n -->
            <div class="paginacion" id="paginacion">
                <!-- Los botones de paginaci√≥n se generar√°n aqu√≠ -->
            </div>

            <button class="btn-agregar" id="btn-agregar-cancion">Agregar Canci√≥n</button>
        </div>
    </section>

    <!-- Modal para agregar/editar canci√≥n -->
    <div id="modal-cancion" class="modal-cancion" style="display: none;">
        <div class="modal-cancion-content">
            <div class="modal-header">
                <h3 id="modal-titulo">Agregar Canci√≥n</h3>
                <button class="btn-cerrar-modal" id="btn-cerrar-modal">&times;</button>
            </div>
            <form id="form-cancion">
                <div class="form-group">
                    <label for="cancion-titulo">T√≠tulo de la Canci√≥n:</label>
                    <input type="text" id="cancion-titulo" placeholder="Ingresa el t√≠tulo" required>
                </div>
                <div class="form-group">
                    <label for="cancion-artista">Artista:</label>
                    <input type="text" id="cancion-artista" placeholder="Ej: Taylor Swift">
                </div>
                <div class="form-group">
                    <label for="cancion-url">Enlace (YouTube, Spotify, etc):</label>
                    <input type="text" id="cancion-url" placeholder="Pega el enlace de la canci√≥n">
                </div>
                <div class="form-group">
                    <label for="cancion-dedicatoria">Dedicatoria:</label>
                    <textarea id="cancion-dedicatoria" placeholder="¬øPor qu√© te dedico esta canci√≥n?" rows="4"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn-cancelar" id="btn-cancelar">Cancelar</button>
                    <button type="submit" class="btn-guardar">Guardar Canci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Hecho con üíô para la persona que amo</p>
        <p class="footer-date">Actualizado el: <span id="fecha"></span></p>
    </footer>

    <script src="../script.js"></script>
    <script>
        const CANCIONES_POR_PAGINA = 12;
        const BACKEND_URL = 'http://localhost:3000/api/canciones';
        let paginaActual = 1;
        let cancionDatosEditando = null;
        let cancionesEnPantalla = [];

        // Cargar canciones del backend
        async function cargarCancionesDelBackend() {
            try {
                const response = await fetch(BACKEND_URL + '/get');
                const data = await response.json();
                
                if (data.success && data.canciones) {
                    window.CANCIONES = data.canciones;
                    cancionesEnPantalla = [...data.canciones];
                    console.log(`üéµ ${data.canciones.length} canciones cargadas del backend`);
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Error cargando canciones del backend:', error);
            }
            return false;
        }

        // Guardar canciones en el backend
        async function guardarCancionesEnBackend() {
            try {
                const response = await fetch(BACKEND_URL + '/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ canciones: window.CANCIONES })
                });
                const data = await response.json();
                return data.success;
            } catch (error) {
                console.error('‚ùå Error guardando canciones:', error);
                return false;
            }
        }
        
        // Filtrar canciones por b√∫squeda
        function filtrarCanciones(texto) {
            const filtro = texto.toLowerCase();
            cancionesEnPantalla = window.CANCIONES.filter(cancion => 
                cancion.titulo.toLowerCase().includes(filtro) || 
                cancion.artista.toLowerCase().includes(filtro) ||
                cancion.razon.toLowerCase().includes(filtro)
            );
            paginaActual = 1;
            mostrarCanciones();
            
            if (cancionesEnPantalla.length === 0 && texto) {
                console.log(`üîç No se encontraron canciones con: "${texto}"`);
            }
        }

        function mostrarCanciones() {
            const container = document.getElementById('canciones-container');
            container.innerHTML = '';
            
            if (cancionesEnPantalla.length === 0) {
                container.innerHTML = '<p class="no-resultados">No hay canciones para mostrar</p>';
                document.getElementById('paginacion').innerHTML = '';
                return;
            }

            const inicio = (paginaActual - 1) * CANCIONES_POR_PAGINA;
            const fin = inicio + CANCIONES_POR_PAGINA;
            const cancionesEnPagina = cancionesEnPantalla.slice(inicio, fin);

            cancionesEnPagina.forEach((cancion, index) => {
                const indicePrincipal = inicio + index;
                const div = document.createElement('div');
                div.className = 'cancion-card';
                div.style.animation = `fadeInUp 0.6s ease-out ${index * 0.1}s both`;
                
                div.innerHTML = `
                    <h3>üéµ ${cancion.titulo}</h3>
                    <p class="cancion-artista">üé§ ${cancion.artista}</p>
                    <p class="cancion-contenido">${cancion.razon}</p>
                    <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.2rem;">
                        <button class="btn-reproducir" onclick="window.open('https://open.spotify.com/search/${encodeURIComponent(cancion.titulo + ' ' + cancion.artista)}', '_blank')">
                            ‚ñ∂ Spotify
                        </button>
                    </div>
                    <div class="botones-cancion-menu">
                        <button class="btn-menu-toggle" onclick="toggleMenuCancion(this)">+</button>
                        <div class="botones-cancion-desplegable">
                            <button class="btn-editar" onclick="editarCancion(${indicePrincipal})">‚úé Editar</button>
                            <button class="btn-eliminar" onclick="eliminarCancion(${indicePrincipal})">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            actualizarPaginacion();
        }

        function actualizarPaginacion() {
            const totalPaginas = Math.ceil(cancionesEnPantalla.length / CANCIONES_POR_PAGINA);
            const paginacionDiv = document.getElementById('paginacion');
            paginacionDiv.innerHTML = '';

            // Bot√≥n anterior
            const btnAnterior = document.createElement('button');
            btnAnterior.className = 'pagina-btn ' + (paginaActual === 1 ? 'deshabilitada' : '');
            btnAnterior.textContent = '‚Üê Anterior';
            btnAnterior.disabled = paginaActual === 1;
            btnAnterior.onclick = () => {
                if (paginaActual > 1) {
                    paginaActual--;
                    mostrarCanciones();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            paginacionDiv.appendChild(btnAnterior);

            // N√∫meros de p√°gina
            for (let i = 1; i <= totalPaginas; i++) {
                const btn = document.createElement('button');
                btn.className = 'pagina-btn ' + (i === paginaActual ? 'activa' : '');
                btn.textContent = i;
                btn.onclick = () => {
                    paginaActual = i;
                    mostrarCanciones();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                paginacionDiv.appendChild(btn);
            }

            // Bot√≥n siguiente
            const btnSiguiente = document.createElement('button');
            btnSiguiente.className = 'pagina-btn ' + (paginaActual === totalPaginas ? 'deshabilitada' : '');
            btnSiguiente.textContent = 'Siguiente ‚Üí';
            btnSiguiente.disabled = paginaActual === totalPaginas;
            btnSiguiente.onclick = () => {
                if (paginaActual < totalPaginas) {
                    paginaActual++;
                    mostrarCanciones();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            paginacionDiv.appendChild(btnSiguiente);
        }

        // Toggle menu
        function toggleMenuCancion(btn) {
            const menu = btn.parentElement.querySelector('.botones-cancion-desplegable');
            menu.classList.toggle('visible');
            btn.classList.toggle('activo');
        }

        // Cerrar men√∫ al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.botones-cancion-menu')) {
                document.querySelectorAll('.botones-cancion-desplegable.visible').forEach(menu => {
                    menu.classList.remove('visible');
                    menu.previousElementSibling.classList.remove('activo');
                });
            }
        });

        // Modal functions
        function mostrarModal(titulo = 'Agregar Canci√≥n') {
            document.getElementById('modal-titulo').textContent = titulo;
            document.getElementById('modal-cancion').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function cerrarModal() {
            document.getElementById('modal-cancion').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('form-cancion').reset();
            cancionDatosEditando = null;
        }

        function abrirFormularioAgregar() {
            cancionDatosEditando = null;
            document.getElementById('form-cancion').reset();
            mostrarModal('Agregar Canci√≥n');
        }

        function editarCancion(indice) {
            cancionDatosEditando = indice;
            const cancion = cancionesEnPantalla[indice];
            document.getElementById('cancion-titulo').value = cancion.titulo;
            document.getElementById('cancion-artista').value = cancion.artista || '';
            document.getElementById('cancion-url').value = cancion.url || '';
            document.getElementById('cancion-dedicatoria').value = cancion.razon || '';
            mostrarModal('Editar Canci√≥n');
        }

        async function eliminarCancion(indice) {
            if (confirm(`¬øEst√°s seguro de que quieres eliminar "${cancionesEnPantalla[indice].titulo}"?`)) {
                // Encontrar el √≠ndice en el array principal
                const indicePrincipal = window.CANCIONES.findIndex(c => c === cancionesEnPantalla[indice]);
                window.CANCIONES.splice(indicePrincipal, 1);
                
                // Guardar en backend
                const guardado = await guardarCancionesEnBackend();
                if (guardado) {
                    filtrarCanciones(document.getElementById('buscador-canciones').value);
                } else {
                    alert('Error al eliminar. Intenta de nuevo.');
                }
            }
        }
            }
        }

        async function guardarCancion(evento) {
            evento.preventDefault();
            
            const titulo = document.getElementById('cancion-titulo').value.trim();
            const artista = document.getElementById('cancion-artista').value.trim();
            const url = document.getElementById('cancion-url').value.trim();
            const razon = document.getElementById('cancion-dedicatoria').value.trim();

            if (!titulo) {
                alert('Por favor completa el t√≠tulo de la canci√≥n');
                return;
            }

            if (cancionDatosEditando !== null) {
                window.CANCIONES[cancionDatosEditando] = { titulo, artista: artista || 'Desconocido', url, razon };
            } else {
                window.CANCIONES.push({ titulo, artista: artista || 'Desconocido', url, razon });
            }

            // Guardar en backend
            const guardado = await guardarCancionesEnBackend();
            if (guardado) {
                mostrarCanciones();
                cerrarModal();
            } else {
                alert('Error al guardar. Intenta de nuevo.');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Cargar canciones del backend
            const cargado = await cargarCancionesDelBackend();
            if (!cargado) {
                console.warn('‚ö†Ô∏è No se pudo cargar del backend, usando array vac√≠o');
                window.CANCIONES = [];
                cancionesEnPantalla = [];
            }
            
            mostrarCanciones();

            // Buscador
            const buscadorInput = document.getElementById('buscador-canciones');
            const btnLimpiar = document.getElementById('btn-limpiar-busqueda');
            
            buscadorInput.addEventListener('input', (e) => {
                filtrarCanciones(e.target.value);
            });
            
            btnLimpiar.addEventListener('click', () => {
                buscadorInput.value = '';
                filtrarCanciones('');
                buscadorInput.focus();
            });

            document.getElementById('btn-agregar-cancion').addEventListener('click', abrirFormularioAgregar);
            document.getElementById('btn-cerrar-modal').addEventListener('click', cerrarModal);
            document.getElementById('btn-cancelar').addEventListener('click', cerrarModal);
            document.getElementById('form-cancion').addEventListener('submit', guardarCancion);

            document.getElementById('modal-cancion').addEventListener('click', (e) => {
                if (e.target.id === 'modal-cancion') {
                    cerrarModal();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('modal-cancion').style.display === 'flex') {
                    cerrarModal();
                }
            });

            // Descargar datos en JSON
            document.getElementById('btn-descargar-canciones').addEventListener('click', function() {
                const dataStr = JSON.stringify(window.CANCIONES, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'canciones-data.json';
                link.click();
                URL.revokeObjectURL(url);
            });

            // Toggle men√∫ m√≥vil mejorado
            const navToggle = document.querySelector('.nav-toggle');
            const navMenu = document.getElementById('menu-simple');
            if (navToggle && navMenu) {
                navToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const abierto = navMenu.classList.toggle('open');
                    navToggle.setAttribute('aria-expanded', abierto ? 'true' : 'false');
                });
                
                // Cerrar men√∫ cuando se hace click en un link
                navMenu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('open');
                        navToggle.setAttribute('aria-expanded', 'false');
                    });
                });
                
                // Cerrar men√∫ cuando se hace click fuera
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.navbar-simple')) {
                        navMenu.classList.remove('open');
                        navToggle.setAttribute('aria-expanded', 'false');
                    }
                });
            }
        });
    </script>
</body>
</html>

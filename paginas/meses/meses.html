<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meses - Nuestra Historia üíô</title>
  <link rel="stylesheet" href="/styles/styles-meses.css" />
  <link rel="stylesheet" href="/styles/styles-index.css" />
  <script src="/config.js"></script>
</head>
<body>
  <nav class="navbar-simple">
    <div class="nav-content">
      <a href="/index.html" class="logo-simple">üíô Nuestra Historia</a>
      <button class="nav-toggle" aria-label="Abrir men√∫" aria-expanded="false" aria-controls="menu-simple">
        <span></span><span></span><span></span>
      </button>
      <ul class="nav-menu-simple" id="menu-simple">
        <li><a href="/index.html">Inicio</a></li>
        <li><a href="/poemas/poemas.html">Poemas</a></li>
        <li><a href="/canciones/canciones.html">Canciones</a></li>
        <li><a href="/galeria/galeria.html">Galer√≠a</a></li>
        <li><a href="meses.html" class="active">Meses</a></li>
      </ul>
    </div>
  </nav>

  <section class="meses">
    <div class="container">
      <h2 class="seccion-titulo">üéâ Nuestros Meses Juntos</h2>
      <p class="intro">Cada mes contigo merece ser recordado y celebrado. Aqu√≠ guardamos la huella de cada etapa de nuestra historia. üíù</p>

      <div id="meses-container"></div>

      <div class="paginacion" id="paginacion"></div>

      <div style="text-align:center; margin:3rem 0;">
        <button class="btn-agregar" id="btn-agregar-mes">+ Agregar Mes</button>
      </div>
    </div>
  </section>

  <!-- Modal -->
  <div id="modal-mes" class="modal-mes" style="display:none;">
    <div class="modal-mes-content">
      <div class="modal-header">
        <h3 id="modal-titulo">Agregar Mes</h3>
        <button class="btn-cerrar-modal" id="btn-cerrar-modal">&times;</button>
      </div>
      <form id="form-mes">
        <div class="form-group">
          <label for="mes-nombre">Mes (ej: Mes 1 / Junio / 1¬∫ Mes)</label>
          <input type="text" id="mes-nombre" required placeholder="Mes 1" />
        </div>
        <div class="form-group">
          <label for="mes-descripcion">Descripci√≥n / Recuerdo especial</label>
          <textarea id="mes-descripcion" rows="5" placeholder="Lo que signific√≥ este mes..." required></textarea>
        </div>
        <div style="display:flex; gap:1rem; justify-content:flex-end;">
          <button type="button" class="btn-cancelar" id="btn-cancelar">Cancelar</button>
          <button type="submit" class="btn-guardar">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <footer class="footer">
    <p>Hecho con üíô para la persona que amo</p>
    <p class="footer-date">Actualizado el: <span id="fecha"></span></p>
  </footer>

  <script>
    // Navbar simple
    (function() {
      const navToggle = document.querySelector('.nav-toggle');
      const navMenu = document.getElementById('menu-simple');
      if (navToggle && navMenu) {
        navToggle.addEventListener('click', e => {
          e.stopPropagation();
          const abierto = navMenu.classList.toggle('open');
          navToggle.setAttribute('aria-expanded', abierto ? 'true' : 'false');
        });
        document.addEventListener('click', e => {
          if (!e.target.closest('.navbar-simple')) {
            navMenu.classList.remove('open');
            navToggle.setAttribute('aria-expanded', 'false');
          }
        });
      }
    })();

    const MESES_POR_PAGINA = 12;
    let paginaActual = 1;
    let mesEditando = null;
    const BACKEND_URL = CONFIG.BACKEND_URL + '/meses';
    window.MESES = [];

    async function cargarMesesBackend() {
      try {
        const res = await fetch(BACKEND_URL + '/get');
        const data = await res.json();
        if (data.success) {
          window.MESES = data.meses || [];
          mostrarMeses();
        }
      } catch (e) {
        console.error('Error cargando meses', e);
      }
    }

    async function guardarMesesBackend() {
      try {
        const res = await fetch(BACKEND_URL + '/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ meses: window.MESES })
        });
        const data = await res.json();
        return data.success;
      } catch (e) {
        console.error('Error guardando meses', e);
        return false;
      }
    }

    function mostrarMeses() {
      const cont = document.getElementById('meses-container');
      cont.innerHTML = '';
      if (MESES.length === 0) {
        cont.innerHTML = '<p class="no-items">A√∫n no hay meses guardados. Agrega el primero üéä</p>';
        return;
      }
      const inicio = (paginaActual - 1) * MESES_POR_PAGINA;
      const fin = inicio + MESES_POR_PAGINA;
      const mesesPagina = MESES.slice(inicio, fin);
      mesesPagina.forEach((m, idx) => {
        const realIndex = inicio + idx;
        const div = document.createElement('div');
        div.className = 'mes-box';
        div.innerHTML = `
          <h3>${m.mes}</h3>
          <p class="mes-descripcion">${m.descripcion}</p>
          <div class="mes-acciones">
            <button class="btn-editar" onclick="editarMes(${realIndex})">‚úé Editar</button>
            <button class="btn-eliminar" onclick="eliminarMes(${realIndex})">üóëÔ∏è Eliminar</button>
          </div>
        `;
        cont.appendChild(div);
      });
      actualizarPaginacion();
    }

    function actualizarPaginacion() {
      const total = Math.ceil(MESES.length / MESES_POR_PAGINA) || 1;
      const pagDiv = document.getElementById('paginacion');
      pagDiv.innerHTML = '';
      const prev = document.createElement('button');
      prev.textContent = '‚Üê Anterior';
      prev.className = 'pagina-btn ' + (paginaActual === 1 ? 'deshabilitada' : '');
      prev.disabled = paginaActual === 1;
      prev.onclick = () => { if (paginaActual > 1) { paginaActual--; mostrarMeses(); window.scrollTo({top:0,behavior:'smooth'}); } };
      pagDiv.appendChild(prev);
      for (let i = 1; i <= total; i++) {
        const b = document.createElement('button');
        b.textContent = i;
        b.className = 'pagina-btn ' + (i === paginaActual ? 'activa' : '');
        b.onclick = () => { paginaActual = i; mostrarMeses(); window.scrollTo({top:0,behavior:'smooth'}); };
        pagDiv.appendChild(b);
      }
      const next = document.createElement('button');
      next.textContent = 'Siguiente ‚Üí';
      next.className = 'pagina-btn ' + (paginaActual === total ? 'deshabilitada' : '');
      next.disabled = paginaActual === total;
      next.onclick = () => { if (paginaActual < total) { paginaActual++; mostrarMeses(); window.scrollTo({top:0,behavior:'smooth'}); } };
      pagDiv.appendChild(next);
    }

    function abrirModal(titulo='Agregar Mes') {
      document.getElementById('modal-titulo').textContent = titulo;
      document.getElementById('modal-mes').style.display = 'flex';
      document.body.style.overflow='hidden';
    }
    function cerrarModal() {
      document.getElementById('modal-mes').style.display='none';
      document.body.style.overflow='auto';
      document.getElementById('form-mes').reset();
      mesEditando=null;
    }
    function editarMes(i){
      mesEditando=i;
      const m=MESES[i];
      document.getElementById('mes-nombre').value=m.mes;
      document.getElementById('mes-descripcion').value=m.descripcion;
      abrirModal('Editar Mes');
    }
    async function eliminarMes(i){
      if(confirm('¬øEliminar este mes?')){
        MESES.splice(i,1);
        const ok=await guardarMesesBackend();
        if(ok){ mostrarMeses(); } else { alert('Error al eliminar'); }
      }
    }
    async function guardarMes(e){
      e.preventDefault();
      const mes = document.getElementById('mes-nombre').value.trim();
      const descripcion = document.getElementById('mes-descripcion').value.trim();
      if(!mes||!descripcion){alert('Completa todos los campos');return;}
      if(mesEditando!==null){
        MESES[mesEditando]={mes,descripcion};
      } else {
        MESES.push({mes,descripcion});
      }
      const ok=await guardarMesesBackend();
      if(ok){ cerrarModal(); mostrarMeses(); } else { alert('Error al guardar'); }
    }

    document.addEventListener('DOMContentLoaded',()=>{
      cargarMesesBackend();
      document.getElementById('btn-agregar-mes').addEventListener('click',()=>{ mesEditando=null; abrirModal('Agregar Mes'); });
      document.getElementById('btn-cerrar-modal').addEventListener('click', cerrarModal);
      document.getElementById('btn-cancelar').addEventListener('click', cerrarModal);
      document.getElementById('form-mes').addEventListener('submit', guardarMes);
      document.getElementById('modal-mes').addEventListener('click', e=>{ if(e.target.id==='modal-mes'){ cerrarModal(); } });
      document.addEventListener('keydown', e=>{ if(e.key==='Escape' && document.getElementById('modal-mes').style.display==='flex'){ cerrarModal(); } });
      const fechaEl=document.getElementById('fecha');
      if(fechaEl){ const d=new Date(); fechaEl.textContent=d.toLocaleDateString('es-ES'); }
    });
  </script>
</body>
</html>

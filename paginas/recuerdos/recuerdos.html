<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuerdos - Nuestra Historia üíô</title>
    <meta name="theme-color" content="#05bfdb">
    <link rel="stylesheet" href="/paginas/styles/styles-recuerdos.css">
</head>
<body>
    <!-- Navbar manual -->
    <nav class="navbar-simple">
        <div class="nav-content">
            <a href="/index.html" class="logo-simple">üíô Nuestra Historia</a>
            <ul class="nav-menu-simple">
                <li><a href="/index.html">Inicio</a></li>
                <li><a href="/paginas/poemas/poemas.html">Poemas</a></li>
                <li><a href="/paginas/canciones/canciones.html">Canciones</a></li>
                <li><a href="/paginas/recuerdos/recuerdos.html">Recuerdos</a></li>
                <li><a href="/paginas/meses/meses.html">Meses</a></li>
            </ul>
        </div>
    </nav>


    <!-- Contenido -->
    <section class="recuerdos-galeria">
        <div class="container">
            <h2 class="seccion-titulo">üí´ Recuerdos <span id="recuerdos-count" style="font-size:0.8em; opacity:.8"></span></h2>
            <p class="intro">Tus momentos guardados. Voltea una tarjeta para leer la dedicatoria ‚ú®</p>

            <!-- Controles de vista -->
            <div class="recuerdos-toolbar">
                <button id="btn-agregar-recuerdo" class="btn-agregar">
                    <span class="btn-icon">üì∏</span>
                    <span>Agregar Recuerdo</span>
                </button>
                <div class="toolbar-right">
                    <label for="orden-recuerdos">Orden:</label>
                    <select id="orden-recuerdos">
                        <option value="desc">M√°s recientes primero</option>
                        <option value="asc">M√°s antiguos primero</option>
                    </select>
                </div>
            </div>

            <!-- Grid de recuerdos -->
            <div id="recuerdos-grid" class="gallery-grid"></div>
        </div>
    </section>

    <!-- Modal para agregar recuerdo -->
    <div id="modal-agregar" class="modal-recuerdo">
        <div class="modal-content-recuerdo">
            <div class="modal-header">
                <h3>üì∏ Agregar Nuevo Recuerdo</h3>
                <button class="modal-close" id="btn-cerrar-modal">&times;</button>
            </div>
            <form id="form-recuerdo" class="recuerdo-form">
                <div class="form-field">
                    <label for="rec-foto">
                        <span class="label-icon">üñºÔ∏è</span>
                        Seleccionar Imagen
                    </label>
                    <input type="file" id="rec-foto" accept="image/*" required>
                    <div id="preview-container" class="preview-container"></div>
                </div>
                <div class="form-field">
                    <label for="rec-fecha">
                        <span class="label-icon">üìÖ</span>
                        Fecha del Recuerdo
                    </label>
                    <input type="date" id="rec-fecha" required>
                </div>
                <div class="form-field">
                    <label for="rec-mensaje">
                        <span class="label-icon">üí≠</span>
                        Mensaje
                    </label>
                    <textarea id="rec-mensaje" rows="3" placeholder="Describe este momento especial..." required></textarea>
                </div>
                <div class="form-field">
                    <label for="rec-dedicatoria">
                        <span class="label-icon">üíù</span>
                        Dedicatoria
                    </label>
                    <textarea id="rec-dedicatoria" rows="2" placeholder="Para la persona que amo..." required></textarea>
                </div>
                <div class="form-field">
                    <label for="rec-autor">
                        <span class="label-icon">‚úçÔ∏è</span>
                        De parte de
                    </label>
                    <input type="text" id="rec-autor" placeholder="Tu nombre..." required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancelar" id="btn-cancelar">Cancelar</button>
                    <button type="submit" class="btn-guardar">
                        <span>üíæ</span>
                        Guardar Recuerdo
                    </button>
                </div>
            </form>
        </div>
    </div>

        <!-- Footer -->
    <footer class="footer-nuevo">
        <p>Hecho con üíô para la persona que amo</p>
        <p class="footer-date">Nuestra historia comenz√≥ el 6 de mayo de 2025 y sigue escribi√©ndose cada d√≠a</p>
    </footer>

    <!-- Script para el navbar -->
    <script>
        // Toggle men√∫ m√≥vil
        const navToggle = document.querySelector('.nav-toggle');
        const navMenu = document.getElementById('menu-simple');
        if (navToggle && navMenu) {
            navToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const abierto = navMenu.classList.toggle('open');
                navToggle.setAttribute('aria-expanded', abierto ? 'true' : 'false');
            });
            navMenu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    navMenu.classList.remove('open');
                    navToggle.setAttribute('aria-expanded', 'false');
                });
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.navbar-simple')) {
                    navMenu.classList.remove('open');
                    navToggle.setAttribute('aria-expanded', 'false');
                }
            });
        }
    </script>

    <script src="/config.js"></script>
    <script>
        const API = CONFIG.BACKEND_URL + '/recuerdos';
        const grid = document.getElementById('recuerdos-grid');
        const selectOrden = document.getElementById('orden-recuerdos');
        window.RECUERDOS = [];
        let editandoId = null; // Variable para saber si estamos editando

        async function cargarRecuerdos() {
            grid.innerHTML = '';
            try {
                const res = await fetch(API + '/get');
                const data = await res.json();
                const lista = data.success ? (data.recuerdos || []) : [];
                window.RECUERDOS = lista;
                actualizarContador(lista.length);
                if (!lista.length) {
                    grid.innerHTML = `<div class="foto-no-encontrada">A√∫n no hay recuerdos. ¬°Sube el primero! ‚ú®</div>`;
                    return;
                }
                mostrarRecuerdos();
            } catch (e) {
                console.error('Error cargando recuerdos', e);
                actualizarContador(0);
                grid.innerHTML = `<div class="foto-no-encontrada">No se pudieron cargar los recuerdos</div>`;
            }
        }

        function actualizarContador(n){
            const cnt = document.getElementById('recuerdos-count');
            if (cnt) cnt.textContent = `(${n})`;
        }

        function ordenarRecuerdos(arr){
            const modo = (selectOrden?.value || 'desc');
            return [...arr].sort((a,b)=>{
                const da = new Date(a.fecha||a.created_at||0).getTime();
                const db = new Date(b.fecha||b.created_at||0).getTime();
                return modo === 'asc' ? (da - db) : (db - da);
            });
        }

        function mostrarRecuerdos(){
            grid.innerHTML = '';
            const ordenados = ordenarRecuerdos(window.RECUERDOS || []);
            ordenados.forEach(r => grid.appendChild(crearCard(r)));
        }

        function crearCard(rec) {
            const card = document.createElement('div');
            card.className = 'recuerdo-card';
            const imgUrl = CONFIG.BACKEND_URL.replace(/\/api$/, '') + rec.url;
            const titulo = formatearFecha(rec.fecha);
            card.innerHTML = `
                <div class="recuerdo-actions">
                    <button class="btn-edit" onclick="editarRecuerdo(${rec.id}, event)" title="Editar">‚úèÔ∏è</button>
                    <button class="btn-delete" onclick="eliminarRecuerdo(${rec.id}, event)" title="Eliminar">üóëÔ∏è</button>
                </div>
                <div class="recuerdo-inner">
                    <div class="recuerdo-front">
                        <div class="recuerdo-image-container">
                            <img src="${imgUrl}" alt="Recuerdo" loading="lazy" decoding="async" onerror="this.src='https://via.placeholder.com/300x300?text=Recuerdo'" />
                        </div>
                        <div class="recuerdo-front-mensaje">
                            <p>${escaparHTML(rec.mensaje || 'Sin mensaje')}</p>
                        </div>
                    </div>
                    <div class="recuerdo-back">
                        <div class="recuerdo-back-content">
                            <p class="recuerdo-fecha-back">üìÖ ${formatearFecha(rec.fecha)}</p>
                            <div class="dedicatoria-icon">üíù</div>
                            <p class="recuerdo-dedicatoria">${escaparHTML(rec.dedicatoria || 'Sin dedicatoria')}</p>
                            <p class="recuerdo-autor">- ${escaparHTML(rec.autor || 'An√≥nimo')}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Click para voltear solo si no es en los botones
            const inner = card.querySelector('.recuerdo-inner');
            inner.addEventListener('click', (e) => {
                if (!e.target.closest('.recuerdo-actions')) {
                    card.classList.toggle('is-flipped');
                }
            });
            
            return card;
        }

        async function eliminarRecuerdo(id, event) {
            event.stopPropagation();
            if (!confirm('¬øEst√°s seguro de eliminar este recuerdo?')) return;
            
            try {
                const res = await fetch(`${API}/delete/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    await cargarRecuerdos();
                } else {
                    alert('Error al eliminar: ' + (data.error || 'desconocido'));
                }
            } catch (err) {
                console.error(err);
                alert('Error al eliminar el recuerdo');
            }
        }

        async function editarRecuerdo(id, event) {
            event.stopPropagation();
            const rec = window.RECUERDOS.find(r => r.id === id);
            if (!rec) return alert('Recuerdo no encontrado');
            
            // Marcar que estamos editando
            editandoId = id;
            
            // Llenar el formulario con los datos actuales
            // Asegurar que la fecha se muestre correctamente sin perder un d√≠a
            if (rec.fecha) {
                const fechaStr = rec.fecha.includes('T') ? rec.fecha : rec.fecha + 'T00:00:00';
                const d = new Date(fechaStr);
                const year = d.getUTCFullYear();
                const month = String(d.getUTCMonth() + 1).padStart(2, '0');
                const day = String(d.getUTCDate()).padStart(2, '0');
                document.getElementById('rec-fecha').value = `${year}-${month}-${day}`;
            } else {
                document.getElementById('rec-fecha').value = '';
            }
            document.getElementById('rec-mensaje').value = rec.mensaje || '';
            document.getElementById('rec-dedicatoria').value = rec.dedicatoria || '';
            document.getElementById('rec-autor').value = rec.autor || '';
            
            // Hacer que el input de foto no sea requerido en modo edici√≥n
            document.getElementById('rec-foto').removeAttribute('required');
            
            // Cambiar el t√≠tulo del modal
            document.querySelector('.modal-header h3').textContent = '‚úèÔ∏è Editar Recuerdo';
            
            // Abrir el modal
            document.getElementById('modal-agregar').classList.add('active');
        }

        function escaparHTML(str) {
            return (str || '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
        }

        function formatearFecha(fecha) {
            if (!fecha) return '';
            // Agregar 'T00:00:00' para evitar problemas de zona horaria
            const fechaStr = fecha.includes('T') ? fecha : fecha + 'T00:00:00';
            const d = new Date(fechaStr);
            return d.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
        }

        function cerrarModal() {
            const modal = document.getElementById('modal-agregar');
            const formRecuerdo = document.getElementById('form-recuerdo');
            const previewContainer = document.getElementById('preview-container');
            modal.classList.remove('active');
            formRecuerdo.reset();
            previewContainer.innerHTML = '';
            // Restaurar t√≠tulo del modal y modo agregar
            document.querySelector('.modal-header h3').textContent = 'üì∏ Agregar Nuevo Recuerdo';
            editandoId = null;
            // Restaurar required en foto
            document.getElementById('rec-foto').setAttribute('required', '');
        }

        document.getElementById('form-recuerdo').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('rec-foto');
            const fechaInput = document.getElementById('rec-fecha');
            const msgInput = document.getElementById('rec-mensaje');
            const dedicatoriaInput = document.getElementById('rec-dedicatoria');
            const autorInput = document.getElementById('rec-autor');
            
            // Si estamos editando
            if (editandoId !== null) {
                const fd = new FormData();
                if (fileInput.files[0]) {
                    fd.append('imagen', fileInput.files[0]);
                }
                fd.append('fecha', fechaInput.value);
                fd.append('mensaje', msgInput.value.trim());
                fd.append('dedicatoria', dedicatoriaInput.value.trim());
                fd.append('autor', autorInput.value.trim());
                
                try {
                    const res = await fetch(`${API}/update/${editandoId}`, { method: 'PUT', body: fd });
                    const data = await res.json();
                    if (data.success) {
                        alert('¬°Recuerdo actualizado! üíô');
                        cerrarModal();
                        await cargarRecuerdos();
                    } else {
                        alert('Error: ' + (data.error || 'No se pudo actualizar'));
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error al actualizar el recuerdo');
                }
                return;
            }
            
            // Modo agregar (original)
            if (!fileInput.files[0]) return alert('Selecciona una foto');
            const fd = new FormData();
            fd.append('foto', fileInput.files[0]);
            fd.append('fecha', fechaInput.value);
            fd.append('mensaje', msgInput.value.trim());
            fd.append('dedicatoria', dedicatoriaInput.value.trim());
            fd.append('autor', autorInput.value.trim());
            try {
                const res = await fetch(API + '/upload', { method: 'POST', body: fd });
                const data = await res.json();
                if (!data.success) return alert('No se pudo guardar el recuerdo');
                fileInput.value = '';
                msgInput.value = '';
                fechaInput.value = '';
                dedicatoriaInput.value = '';
                autorInput.value = '';
                await cargarRecuerdos();
            } catch(err) {
                console.error(err);
                alert('Error subiendo el recuerdo');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Footer igual al index
            (function(){
                const FECHA_INICIO = new Date(2025, 4, 6);
                const meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
                const dia = FECHA_INICIO.getDate();
                const mes = meses[FECHA_INICIO.getMonth()];
                const anio = FECHA_INICIO.getFullYear();
                const fechaFormato = `${dia} de ${mes} de ${anio}`;
                const footerSince = document.getElementById('footerSince');
                if (footerSince) footerSince.textContent = `Nuestra historia comenz√≥ el ${fechaFormato} y sigue escribi√©ndose cada d√≠a`;
            })();

            // Cargar y preparar eventos
            cargarRecuerdos();
            if (selectOrden) selectOrden.addEventListener('change', mostrarRecuerdos);

            // MODAL - Agregar Recuerdo
            const modal = document.getElementById('modal-agregar');
            const btnAgregar = document.getElementById('btn-agregar-recuerdo');
            const btnCerrar = document.getElementById('btn-cerrar-modal');
            const btnCancelar = document.getElementById('btn-cancelar');
            const formRecuerdo = document.getElementById('form-recuerdo');
            const inputFoto = document.getElementById('rec-foto');
            const previewContainer = document.getElementById('preview-container');

            // Abrir modal en modo agregar
            if (btnAgregar) {
                btnAgregar.addEventListener('click', () => {
                    editandoId = null; // Asegurar que estamos en modo agregar
                    document.getElementById('rec-foto').setAttribute('required', '');
                    document.querySelector('.modal-header h3').textContent = 'üì∏ Agregar Nuevo Recuerdo';
                    modal.classList.add('active');
                });
            }

            // Cerrar modal
            // La funci√≥n cerrarModal ya est√° definida arriba globalmente

            if (btnCerrar) btnCerrar.addEventListener('click', cerrarModal);
            if (btnCancelar) btnCancelar.addEventListener('click', cerrarModal);

            // Cerrar al hacer clic fuera del modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) cerrarModal();
            });

            // Preview de imagen
            inputFoto.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        previewContainer.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // El manejador de submit ya est√° definido arriba, no agregarlo de nuevo
        });
    </script>
</body>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuerdos</title>
    <link rel="stylesheet" href="../styles/navbar.css">
    <link rel="stylesheet" href="../styles/styles-index.css">
</head>
<body>
    <nav>
        <a href="/index.html" class="navbar-title">üíô Nuestra Historia</a>
        <ul>
            <li><a href="/index.html">Inicio</a></li>
            <li><a href="/paginas/poemas/poemas.html">Poemas</a></li>
            <li><a href="/paginas/canciones/canciones.html">Canciones</a></li>
            <li><a href="/paginas/recuerdos/recuerdos.html">Recuerdos</a></li>
            <li><a href="/paginas/meses/meses.html">Meses</a></li>
        </ul>
    </nav>
    <main>
        <div class="cuadro-historia historia">
            <h1>Recuerdos</h1>
            <div class="subtitulo">Momentos capturados para siempre</div>
            <!-- Contenido de recuerdos -->
        </div>
    </main>
    <footer>
        &copy; 2025 Nuestra Historia. Creado con <span class="footer-heart">üíô</span> por JuanPa435.
    </footer>
</body>
</html>

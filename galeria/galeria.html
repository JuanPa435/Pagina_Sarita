<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GalerÃ­a - Nuestra Historia ðŸ’™</title>
    <meta name="theme-color" content="#05bfdb">
    <link rel="stylesheet" href="../styles/styles-galeria.css">
    <link rel="stylesheet" href="../styles/styles-modal-galeria.css">
    <!-- Navbar del index -->
    <link rel="stylesheet" href="../styles/styles-index.css">
</head>
<body>
    <!-- Navbar igual al index (adaptando rutas relativas) -->
    <nav class="navbar-simple">
        <div class="nav-content">
            <a href="../index.html" class="logo-simple">ðŸ’™ Nuestra Historia</a>
            <button class="nav-toggle" aria-label="Abrir menÃº" aria-expanded="false" aria-controls="menu-simple">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu-simple" id="menu-simple">
                <li><a href="../index.html">Inicio</a></li>
                <li><a href="../poemas/poemas.html">Poemas</a></li>
                <li><a href="../canciones/canciones.html">Canciones</a></li>
                <li><a href="galeria.html">GalerÃ­a</a></li>
                <li><a href="../mensajes/mensajes.html">Mensajes</a></li>
            </ul>
        </div>
    </nav>

    <!-- Contenido -->
    <section class="galeria">
        <div class="container">
            <h2 class="seccion-titulo">ðŸ“¸ GalerÃ­a de Fotos</h2>
            
            <div class="gallery-controls">
                <button class="btn-upload" id="btn-subir-fotos">Subir fotos</button>
                <input type="file" id="file-input" accept="image/*" multiple>
            </div>

            <div id="galeria-container" class="gallery-grid"></div>
        </div>
    </section>

    <!-- Script para el navbar -->
    <script>
        // Toggle menÃº mÃ³vil
        const navToggle = document.querySelector('.nav-toggle');
        const navMenu = document.getElementById('menu-simple');
        if (navToggle && navMenu) {
            navToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const abierto = navMenu.classList.toggle('open');
                navToggle.setAttribute('aria-expanded', abierto ? 'true' : 'false');
            });
            
            // Cerrar menÃº cuando se hace click en un link
            navMenu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    navMenu.classList.remove('open');
                    navToggle.setAttribute('aria-expanded', 'false');
                });
            });
            
            // Cerrar menÃº cuando se hace click fuera
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.navbar-simple')) {
                    navMenu.classList.remove('open');
                    navToggle.setAttribute('aria-expanded', 'false');
                }
            });
        }
    </script>

    <script src="../config.js"></script>
    <script src="../script.js"></script>

    <!-- Modal de visualizaciÃ³n -->
    <div id="modal-visualizar" class="modal">
        <div class="modal-content">
            <span class="close" id="cerrar-visualizar">&times;</span>
            <img id="visualizar-img" class="modal-img" alt="Foto">
            <div class="modal-buttons">
                <button class="btn-descargar" id="btn-descargar">Descargar</button>
                <button class="btn-cerrar-modal" id="btn-cerrar-visualizar">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal agregar/editar foto -->
    <div id="modal-galeria" class="modal-galeria" style="display:none;">
        <div class="modal-galeria-content">
            <div class="modal-header">
                <h3 id="modal-galeria-titulo">Agregar/Editar Foto</h3>
                <button class="btn-cerrar-modal" id="btn-cerrar-editar">&times;</button>
            </div>
            <form id="form-foto">
                <div class="form-group">
                    <label for="foto-autor">Â¿QuiÃ©n la subiÃ³?</label>
                    <input type="text" id="foto-autor" placeholder="Nombre" />
                </div>
                <div class="form-group">
                    <label for="foto-descripcion">DescripciÃ³n</label>
                    <textarea id="foto-descripcion" rows="3" placeholder="Escribe una descripciÃ³n"></textarea>
                </div>
                <div class="form-group">
                    <label for="foto-reemplazar">Reemplazar imagen (opcional)</label>
                    <input type="file" id="foto-reemplazar" accept="image/*" />
                </div>
                <div style="display:flex; gap:1rem; justify-content:flex-end;">
                    <button type="button" class="btn-cancelar" id="btn-cancelar-editar">Cancelar</button>
                    <button type="submit" class="btn-guardar">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const BACKEND_URL = CONFIG.BACKEND_URL + '/galeria';
        let FOTOS = [];
        let indiceEditando = null;

        async function cargarGaleria() {
            try {
                const res = await fetch(BACKEND_URL + '/get');
                const data = await res.json();
                if (data.success && Array.isArray(data.fotos)) {
                    FOTOS = data.fotos;
                } else {
                    FOTOS = [];
                }
                renderGaleria();
            } catch (e) {
                console.error('Error cargando galerÃ­a:', e);
                FOTOS = [];
                renderGaleria();
            }
        }

        function renderGaleria() {
            const grid = document.getElementById('galeria-container');
            grid.innerHTML = '';
            if (!FOTOS.length) {
                grid.innerHTML = `
                    <div class="foto-no-encontrada">No hay fotos todavÃ­a. Â¡Sube tus primeras fotos! ðŸ’™</div>
                `;
                return;
            }
            FOTOS.forEach((item, idx) => {
                const card = document.createElement('div');
                card.className = 'galeria-item';
                card.innerHTML = `
                    <div class="checkbox-wrapper" style="display:none;">
                        <input type="checkbox" />
                    </div>
                    ${item.src ? `<img src="${item.src}" alt="Foto ${idx+1}">` : `<div class='foto-no-encontrada'>Foto no disponible</div>`}
                    <div class="galeria-overlay">
                        <button class="btn-ver" data-accion="ver" data-idx="${idx}">Ver</button>
                        <button class="btn-ver" data-accion="editar" data-idx="${idx}">Editar</button>
                        <button class="btn-ver" data-accion="eliminar" data-idx="${idx}">Eliminar</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        async function guardarGaleria() {
            const res = await fetch(BACKEND_URL + '/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fotos: FOTOS })
            });
            const data = await res.json();
            return !!data.success;
        }

        async function subirArchivo(file) {
            const form = new FormData();
            form.append('foto', file);
            const res = await fetch(BACKEND_URL + '/upload', { method: 'POST', body: form });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Error subiendo');
            return data.url;
        }

        // Eventos UI
        document.getElementById('btn-subir-fotos').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });

        document.getElementById('file-input').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files || []);
            if (!files.length) return;
            try {
                for (const f of files) {
                    const url = await subirArchivo(f);
                    FOTOS.push({ src: url, autor: '', descripcion: '', fecha: new Date().toISOString().slice(0,10) });
                }
                const ok = await guardarGaleria();
                if (ok) renderGaleria();
                else alert('No se pudo guardar la galerÃ­a');
            } catch (err) {
                console.error(err);
                alert('Error al subir alguna foto');
            } finally {
                e.target.value = '';
            }
        });

        // DelegaciÃ³n de eventos para ver/editar/eliminar
        document.getElementById('galeria-container').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const accion = btn.dataset.accion;
            const idx = parseInt(btn.dataset.idx, 10);
            if (Number.isNaN(idx)) return;

            if (accion === 'ver') {
                const item = FOTOS[idx];
                document.getElementById('visualizar-img').src = item.src;
                document.getElementById('modal-visualizar').classList.add('active');
            }
            if (accion === 'editar') {
                indiceEditando = idx;
                const item = FOTOS[idx];
                document.getElementById('modal-galeria-titulo').textContent = 'Editar Foto';
                document.getElementById('foto-autor').value = item.autor || '';
                document.getElementById('foto-descripcion').value = item.descripcion || '';
                document.getElementById('modal-galeria').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            if (accion === 'eliminar') {
                const conf = confirm('Â¿Eliminar esta foto?');
                if (!conf) return;
                FOTOS.splice(idx, 1);
                const ok = await guardarGaleria();
                if (ok) renderGaleria();
                else alert('No se pudo guardar los cambios');
            }
        });

        // Modal visualizar
        document.getElementById('cerrar-visualizar').addEventListener('click', () => {
            document.getElementById('modal-visualizar').classList.remove('active');
        });
        document.getElementById('btn-cerrar-visualizar').addEventListener('click', () => {
            document.getElementById('modal-visualizar').classList.remove('active');
        });
        document.getElementById('btn-descargar').addEventListener('click', () => {
            const src = document.getElementById('visualizar-img').src;
            const a = document.createElement('a');
            a.href = src;
            a.download = src.split('/').pop();
            a.click();
        });

        // Modal editar
        function cerrarModalEditar() {
            document.getElementById('modal-galeria').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('form-foto').reset();
            indiceEditando = null;
        }
        document.getElementById('btn-cerrar-editar').addEventListener('click', cerrarModalEditar);
        document.getElementById('btn-cancelar-editar').addEventListener('click', cerrarModalEditar);
        document.getElementById('modal-galeria').addEventListener('click', (e) => {
            if (e.target.id === 'modal-galeria') cerrarModalEditar();
        });

        document.getElementById('form-foto').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (indiceEditando === null) return cerrarModalEditar();
            const autor = document.getElementById('foto-autor').value.trim();
            const descripcion = document.getElementById('foto-descripcion').value.trim();
            const reemplazo = document.getElementById('foto-reemplazar');

            try {
                if (reemplazo.files && reemplazo.files[0]) {
                    const nuevaUrl = await subirArchivo(reemplazo.files[0]);
                    FOTOS[indiceEditando].src = nuevaUrl;
                }
                FOTOS[indiceEditando].autor = autor;
                FOTOS[indiceEditando].descripcion = descripcion;
                const ok = await guardarGaleria();
                if (ok) {
                    cerrarModalEditar();
                    renderGaleria();
                } else {
                    alert('No se pudo guardar los cambios');
                }
            } catch (err) {
                console.error(err);
                alert('Error al guardar');
            }
        });

        document.addEventListener('DOMContentLoaded', cargarGaleria);
    </script>
</body>
</html>
